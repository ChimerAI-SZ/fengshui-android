这是一份非常详尽且富有野心的产品规划。基于你提供的V0-V4的详细需求，我将分两步来协助你：首先解决交互细节与技术架构的“关键决策”，然后基于这些决策生成一份项目开发所需的“权威文档（Single Source of Truth）”。
________________________________________
第一部分：关键交互细节与技术决策讨论
在生成最终文档前，我们需要对以下几个模糊点进行“定板”。基于移动端地图开发的最佳实践（如高德/Google Maps开发经验）和风水工具的特殊性，我给出以下建议方案。如果这些方案你认可，它们将直接写入文档。
1. 交互细节“定板”建议
•	Q1：标记点后，地图中心停留在哪？ 
o	场景：用户拖拽地图选中了一个点，点击“设为终点”。
o	建议：保持当前视图不动，或微调使该点处于可视化区域中心，但不跳回GPS。
o	理由：堪舆往往是远程操作或基于当前观察点操作。用户刚选完一个位置，通常需要确认该位置周边的环境（如路冲、水口），如果跳回GPS，用户会丢失上下文，体验极差。
•	Q2：连线触发时机与视图调整 
o	场景：原点已定，刚选好终点。
o	建议：自动连线，且视图执行“Fit Bounds（边界适应）”动画。
o	理由：V0需求中提到“视角沿着连线移回该原点”，这在短距离有效。但如果原点在北京，终点在上海，移回原点会导致终点在屏幕外。更好的方案是：自动缩放地图层级，使得原点和终点同时刚好出现在屏幕内（Fit Bounds），并在底部显示数据面板。
•	Q3：罗盘显示的层级逻辑 
o	场景：地图上有原点，也有GPS定位。
o	建议： 
	未定原点时：罗盘跟随 GPS定位 或 屏幕中心十字（取决于V1的锁定模式）。
	已定原点时：罗盘强制吸附在原点。
	理由：风水的核心是“立极”（确定中心）。一旦立极（确定原点），所有的二十四山方位都是相对于这个原点产生的，GPS此时只代表“我站在哪里”，不再是风水计算的中心。
2. 数据库与技术架构设计思路
•	堪舆数据的本质（存什么？）
o	核心误区：新手容易把“坐向、五行、八卦”存进数据库。
o	正确做法：数据库只存坐标（经纬度）和元数据（名字、时间）。
o	逻辑：方位角（Azimuth）、二十四山、吉凶推演全部由算法层（Service Layer）实时计算。
o	好处：如果你以后想把“八运”改成“九运”算法，或者修正磁偏角算法，不需要刷库，只需要改代码。
•	地图抽象层（Map Abstract Layer）如何建立？
o	目的：为了以后能换地图源（比如国内用高德，国外用Google/Mapbox），或者切换卫星图源。
o	方法：不要在业务代码里直接写 GoogleMap.addMarker()。
o	设计接口（Interface）： 
	IMapController: 定义 moveTo(lat, lng), addMarker(options), drawPolyline(points).
	IMapListener: 定义 onCameraMove, onTap.
o	实现：编写 GaodeMapAdapter 实现上述接口。业务逻辑只调用接口。
________________________________________
第二部分：项目权威开发文档 (The Master Document)
以下是基于你的输入整理的完整技术规格说明书。在开发过程中，请以此文档为准。
24山风水堪舆罗盘 App - 开发规格说明书 (V0-V4)
版本日期：2026-02-01 状态：已冻结 (待开发) 文档目标：作为项目单一事实来源，指导编码、设计与测试。
________________________________________
1. 技术架构选型
1.1 技术栈建议
•	前端框架：Flutter (推荐) 或 React Native。 
o	理由：高性能渲染罗盘动画，且地图SDK支持完善（高德/Google双端支持）。
•	地图SDK： 
o	国内版：高德地图 SDK (AMap) 或 百度地图 SDK。
o	国际版（可选）：Mapbox 或 Google Maps。
o	抽象层要求：必须封装 MapService，禁止UI层直接依赖特定地图SDK类。同时满足高德地图和谷歌地图的要求
•	本地数据库：SQLite (通过 ORM 库，如 Flutter 的 Drift 或 Isar)。
•	状态管理：Provider / Riverpod / Bloc。
1.2 核心算法库 (Logic Layer)
需要独立封装 FengShuiEngine 类，包含以下纯数学方法（不依赖UI）：
•	calculateAzimuth(Point a, Point b): 计算两点间角度 (0-360)。
•	get24Mountain(degree): 输入角度，返回对应的山（如“子山”、“癸山”）。
•	getDistance(Point a, Point b): 计算大圆距离（考虑地球曲率）。
•	getFanArea(center, degree, distance, spread): 生成扇形覆盖物多边形点集。
________________________________________
2. 数据库设计 (Schema)
数据库主要存储“人、案、点”。风水计算结果不存储。
2.1 表结构定义
Table: Cases (堪舆案例)
字段名	类型	说明
id	UUID/Int	主键
title	String	案例名称 (必填)
description	String	案例描述 (可选)
created_at	DateTime	创建时间
updated_at	DateTime	更新时间
type	Int	0: 普通案例, 1: 生活圈模式 (特殊案例)
Table: Points (点位信息)
字段名	类型	说明
id	UUID/Int	主键
case_id	UUID/Int	外键，关联 Cases 表
name	String	点位名称 (如"大门", "主卧")
latitude	Double	纬度 (高精度)
longitude	Double	经度 (高精度)
role	Int	0: 原点 (立极点), 1: 终点 (砂水点)
sort_order	Int	用于列表排序
(注：两点间的连线关系是通过 case_id 动态生成的。一个Case下，所有的“终点”都与该Case下的当前选中“原点”相连。)
________________________________________
3. 功能详细说明与交互逻辑
3.1 地图基础与罗盘 (V0)
•	地图初始化： 
o	申请权限：GPS定位、指南针传感器。
o	控件：右侧比例尺加减（调用地图 zoomIn/zoomOut），图层切换（卫星/矢量）。
•	罗盘逻辑 (Compass Overlay)： 
o	状态A (无原点)：罗盘中心绑定当前GPS位置，根据手机传感器旋转。
o	状态B (有原点)：罗盘中心绑定在地图上的“原点”Marker上。
o	UI表现：屏幕中心始终悬浮一个半透明“十字准星”（用于选点）。
3.2 案例与连线核心 (V0 - V1)
•	新建点位交互： 
o	操作：点击右侧“+”或点击屏幕中心十字。
o	流程：弹出对话框 -> 输入名称 -> 选择角色(原点/终点) -> 归属当前案例 -> 保存。
•	连线逻辑 (Render Logic)： 
o	触发：当一个案例中同时存在 1个选中原点 + N个选中终点时。
o	渲染：绘制从原点指向每一个终点的直线（Polyline）。
o	视觉：罗盘位于原点。
o	视角动作： 
	新建终点后：视角自动平滑移动（animateCamera），使得原点居中或原点与终点均可见。
•	数据面板： 
o	操作：点击地图上的连线。
o	显示：底部弹出/覆盖层，显示：名称(原-终)、经纬度、方位角、24山(如：子山午向)、八卦、五行、直线距离。
3.3 进阶交互 (V1)
•	罗盘锁定/解锁： 
o	锁定模式：罗盘像钉子一样钉在地图经纬度上。拖动地图，罗盘随地图移动（保持地理位置不变）。
o	解锁模式：罗盘浮在屏幕玻璃上（屏幕中心）。拖动地图，罗盘不动，地图在下面动（用于快速用罗盘去套不同的点）。
•	多点管理： 
o	原点切换：右侧“原点”按钮 -> 列表弹窗 -> 单选。切换后，重新计算所有连线。
o	终点筛选：右侧“终点”按钮 -> 列表弹窗 -> 多选/全选/清空。
o	空状态处理：若无数据，Toast提示“暂无原点/终点，请在管理中添加”。
3.4 堪舆管理系统 (V1/V4)
•	入口：底部Tab栏 [地图] | [堪舆管理] | [搜索] | [说明]。
•	管理列表： 
o	展示所有案例。
o	展开交互：点击箭头展开案例 -> 显示该案例下所有点 -> 支持删除/重命名/快速加点。
o	快速加点：在列表里点“+” -> 跳转回地图模式，进入选点状态。
3.5 高级搜索与扇形分析 (V2)
•	扇形绘制 (Sector Search)：
o	起点逻辑：优先使用当前原点；无原点则用屏幕中心。
o	参数设置： 
	方位：24山模式 (15°夹角) / 8卦模式 (45°夹角)。
	距离：输入值 (0.1km - 5000km)。小于0.1或大于5000禁止提交。
	POI关键词：可选。
o	渲染实现：计算出扇形多边形的顶点坐标数组 -> 在地图上绘制半透明 Polygon。
o	POI搜索逻辑： 
	调用地图 searchInBounds 或 searchInPolygon (若SDK不支持多边形搜索，则先搜矩形范围，再用算法过滤掉不在扇形内的点)。
	限制：距离>250km时，仅显示提示，不执行API搜索（节省成本且避免无意义数据）。
	反馈：Toast提示“在[20km]范围内找到[5]个[医院]”。
•	十字准心搜索模式：
o	流程：搜索Tab -> 输入地址 -> 列表点击 -> 跳转地图。
o	微调：地图中心显示十字，用户拖动地图来“对准”目标建筑。
o	保存：点击底部“保存位置” -> 存入数据库。
3.6 生活圈模式 (V3)
•	数据隔离： 
o	在 Cases 表中创建特殊 Case (type=1)，或使用独立逻辑。
o	进入模式时，隐藏普通案例的 Overlay。
•	向导流程： 
o	Step 1: 定位“家” (Set Point A)。
o	Step 2: 定位“公司” (Set Point B)。
o	Step 3: 定位“娱乐” (Set Point C)。
o	结果：同时显示3个罗盘（每个点一个），并显示三点连线（三角形）。
o	注：此处需明确，三个罗盘是独立的，分别以各自为立极点显示方位。
________________________________________
4. 开发阶段规划 (Roadmap)
1.	Phase 1 (Data & Map Core): 
o	搭建 SQLite 数据库。
o	实现地图抽象层。
o	实现“屏幕中心十字”和“GPS定位”同步。
2.	Phase 2 (The Compass & V0): 
o	实现罗盘 UI（图片/Canvas绘制）。
o	实现 V0 的单原点、单终点连线与算命数据面板。
3.	Phase 3 (Case Management system): 
o	完成 V1 的多点、多案例逻辑。
o	完成列表页的增删改查。
4.	Phase 4 (Advanced Logic): 
o	实现 V2 扇形算法与绘制。
o	集成 POI 搜索 API。
o	实现 V3 生活圈向导。
5.	Phase 5 (Polish): 
o	V4 新手引导、说明书。
o	UI 美化与动画流畅度优化。
________________________________________
给开发者的特别提示 (Tips for AI Coding)
•	Prompting 技巧：在让 AI 写代码时，每次请指定：“Use the IMapController interface defined in map_interface.dart, do not use GoogleMap directly.”
•	坐标系坑：注意国内地图（高德/百度）使用 GCJ-02 或 BD-09 坐标系，而国际通用的风水计算（及GPS）通常基于 WGS-84。所有存入数据库的坐标，建议统一转换为 WGS-84，显示时再转回地图对应坐标系，或者在存入时标记坐标系类型，防止位置偏移。
•	Mercator 投影：在计算长距离（>500km）方位角时，普通的平面几何计算会失效。必须使用 Geodesic（大地测量线） 算法来计算方位角和距离。
________________________________________
这份文档现在就是你的Project Bible。开发时遇到逻辑疑问，先回看这里。如果准备好了，我们可以开始第一步：搭建数据库模型和地图抽象层。

