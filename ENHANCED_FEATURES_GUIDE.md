# 增强点位功能完整指南 - V2.0

## 核心功能总览

本次更新实现了基于交互细节文档的**原点/终点/连线管理系统**，支持多案例、多角色点位管理和自动连线生成。

---

## 🎯 主要功能

### 1. **堪舆案例管理**

#### 功能特性
- ✅ 创建多个独立的堪舆案例
- ✅ 实时切换工作案例
- ✅ 长按案例标签快速删除
- ✅ 案例内数据完全独立

#### 使用步骤
```
点击"+ 新建案例" 
  → 输入案例名称 
  → 点击"创建" 
  → 新案例自动选中
```

#### 案例数据结构
```javascript
{
  id: "timestamp",          // 唯一标识
  name: "案例名称",         // 显示名称
  createdAt: "ISO时间"      // 创建时间
}
```

---

### 2. **原点/终点加点系统**

#### 新增加点流程
与之前简单的"添加点位"不同，新流程支持更复杂的结构：

```
点击"+ 在十字准星处加点"
  ↓
弹出加点对话框
  ├─ 选择点的类型: 🔴 原点 / 🔵 终点
  ├─ 选择关联案例
  ├─ 输入点的名称
  └─ 确认当前位置信息
  ↓
点击"保存"
  ↓
系统自动检测:
  ├─ 如果添加终点 → 查找同案例所有原点并自动生成连线
  └─ 如果添加原点 → 查找同案例所有终点并自动生成连线
```

#### 点位类型

**🔴 原点 (Origin Point)**
- 代表堪舆分析的起始位置
- 通常为参考点或基准点
- 一个案例最多支持 2 个原点

**🔵 终点 (Endpoint)**  
- 代表堪舆分析的目标位置
- 相对于原点进行方位分析
- 一个案例最多支持 5 个终点

#### 点位数据结构
```javascript
{
  id: "timestamp",              // 唯一标识
  caseId: "case_id",            // 关联案例
  pointType: "origin|endpoint",  // 点的类型
  name: "点的名称",             // 用户自定义名称
  angle: 145.5,                 // 当前罗盘指向角度
  mountain: "坤",               // 24山方位
  fenjin: "甲子",               // 分金
  element: "土",                // 五行属性
  bagua: "坤",                  // 八卦（从山位推导）
  latitude: 39.9,               // 纬度（模拟数据）
  longitude: 116.4,             // 经度（模拟数据）
  addedAt: "ISO时间"            // 添加时间
}
```

---

### 3. **自动连线生成**

#### 工作原理

当添加点位时，系统会自动检测是否需要生成连线：

```
添加终点时:
  → 查询数据库: 同案例的所有原点
  → 逐一为: 原点-终点配对生成连线

添加原点时:
  → 查询数据库: 同案例的所有终点
  → 逐一为: 原点-终点配对生成连线
```

#### 连线包含的信息

当连线自动生成时，系统计算以下信息：

| 项目 | 含义 | 计算方式 |
|------|------|---------|
| 方位角 | 原点指向终点的角度 | Bearing 公式 |
| 直线距离 | 两点间地面距离 | Haversine 公式 |
| 山位 | 方位角对应的24山 | 角度范围匹配 |
| 八卦 | 山位对应的八卦 | 映射表查询 |
| 五行 | 山位的五行属性 | 映射表查询 |

#### 连线数据结构
```javascript
{
  id: "unique_id",              // 唯一标识
  caseId: "case_id",            // 关联案例
  originId: "point_id",         // 原点ID
  originName: "原点名称",       // 原点名称
  endpointId: "point_id",       // 终点ID
  endpointName: "终点名称",     // 终点名称
  bearing: "145.5",             // 方位角（度数）
  distance: "8.35",             // 直线距离（km）
  mountain: "坤",               // 山位
  element: "土",                // 五行
  bagua: "坤",                  // 八卦
  createdAt: "ISO时间"          // 创建时间
}
```

---

### 4. **连线管理与查看**

#### 查看连线列表

```
点击"📈连线(N)" 按钮
  ↓
弹出连线列表对话框
  ├─ 显示所有原点-终点连线
  ├─ 每条连线展示:
  │  ├─ 方位角和山位
  │  ├─ 直线距离
  │  ├─ 五行和八卦
  │  └─ [删除]按钮
  └─ 关闭对话框
```

#### 连线列表信息

单条连线显示格式：
```
🔴 原点名称 → 🔵 终点名称
方位角: 145.5° | 坤
直线距离: 8.35 km | 五行: 土  
八卦: 坤
```

#### 连线操作

- **查看详情**：点击连线，显示完整信息
- **删除连线**：点击[删除]按钮移除该连线记录
- **删除关联点**：当删除某个点位时，相关连线自动删除

---

## 📋 使用工作流程

### 完整使用示例

#### 场景：分析两个物业的风水关系

**第一步：创建案例**
```
1. 点击"+ 新建案例"
2. 输入: "商业物业A-B风水分析"
3. 点击"创建"
```

**第二步：添加原点（参考位置）**
```
1. 点击"+ 在十字准星处加点"
2. 选择类型: 🔴 原点
3. 选择案例: 商业物业A-B风水分析
4. 输入名称: "物业A"
5. 调整手机方向，对准物业A位置的十字准星
6. 点击"保存"
   → 系统记录: {原点ID1, 物业A, 当前方向}
```

**第三步：添加终点（分析目标）**
```
1. 点击"+ 在十字准星处加点"
2. 选择类型: 🔵 终点
3. 选择案例: 商业物业A-B风水分析
4. 输入名称: "物业B"
5. 调整手机方向，对准物业B位置的十字准星
6. 点击"保存"
   → 系统自动生成连线: 物业A → 物业B
   → 计算: 方位角、距离、山位、八卦、五行
```

**第四步：查看分析结果**
```
1. 点击"📍点位(2)" 查看两个点的详细信息
   ├─ 原点: 物业A - 角度/山位/五行/八卦
   └─ 终点: 物业B - 角度/山位/五行/八卦

2. 点击"📈连线(1)" 查看原点-终点连线信息
   └─ 物业A → 物业B
      - 方位角: XXX°
      - 山位: XX
      - 直线距离: XX km
      - 五行: XX
      - 八卦: XX
```

---

## 🎨 UI 布局说明

### 主界面结构

```
┌─────────────────────────────────────┐
│  24山风水测量工具 v2.0              │
├─────────────────────────────────────┤

┌─────────────────────────────────────┐
│ 堪舆案例: 商业物业分析              │
├─────────────────────────────────────┤
│ [+ 新建案例] [📍点位(2)] [📈连线(1)]│
│ [商业物业A] [商业物业B] [...]        │
└─────────────────────────────────────┘

       ┌─────────────┐
       │  十字准星↓  │
       │     #       │
       │  ┌───────┐  │
       │  │ 145.5°│  │
       │  │   坤  │  │
       │  │  甲子 │  │
       │  └───────┘  │
       └─────────────┘

┌─────────────────────────────────────┐
│ 原点数: 1  终点数: 1  连线数: 1     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 详细信息                            │
│ 方位: 坤     五行: 土               │
│ 八卦: 坤     分金: 甲子             │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ [+ 在十字准星处加点]                │
│ [🧭 校准罗盘]                       │
└─────────────────────────────────────┘
```

### 加点对话框

```
┌────────────────────────────────────┐
│  在十字准星处加点                  │
├────────────────────────────────────┤
│
│  点的类型:
│  [🔴 原点]  [🔵 终点]
│
│  选择案例:
│  [商业物业分析]  [其他案例]
│
│  点的名称:
│  ┌────────────────────┐
│  │ 输入点的名称       │
│  └────────────────────┘
│
│  当前位置: 坤 (145.5°)
│
│  [取消]  [保存]
│
└────────────────────────────────────┘
```

### 点位列表对话框

```
┌────────────────────────────────────┐
│  商业物业分析 - 点位记录           │
├────────────────────────────────────┤
│
│  🔴 物业A
│  坤 (145.5°) | 土
│  分金: 甲子 | 八卦: 坤
│  2026-02-09 10:30:45  [删除]
│
│  🔵 物业B
│  乾 (330.5°) | 金
│  分金: 丙子 | 八卦: 乾
│  2026-02-09 10:35:20  [删除]
│
│          [关闭]
│
└────────────────────────────────────┘
```

### 连线列表对话框

```
┌────────────────────────────────────┐
│  商业物业分析 - 连线信息           │
├────────────────────────────────────┤
│
│  🔴 物业A → 🔵 物业B
│  方位角: 280.5° | 兑
│  直线距离: 8.35 km | 五行: 金
│  八卦: 兑  [删除]
│
│          [关闭]
│
└────────────────────────────────────┘
```

---

## 📊 数据统计

### 案例统计信息

在主界面显示三个关键指标：

```
┌──────────────┬──────────────┬──────────────┐
│  原点数      │  终点数      │  连线数      │
│      1       │      2       │      2       │
└──────────────┴──────────────┴──────────────┘
```

- **原点数**：当前案例中标记为"原点"的点位总数
- **终点数**：当前案例中标记为"终点"的点位总数  
- **连线数**：当前案例中自动生成的连线总数

---

## 🔧 技术实现细节

### 关键算法

#### 1. Bearing（方位角）计算
```
使用球面三角学计算两点间的方位角
bearing = atan2(sin(dLon) * cos(lat2), 
                cos(lat1) * sin(lat2) - 
                sin(lat1) * cos(lat2) * cos(dLon))
```

#### 2. Haversine（距离）计算
```
a = sin²(Δlat/2) + cos(lat1) * cos(lat2) * sin²(Δlon/2)
c = 2 * atan2(√a, √(1−a))
distance = R * c  (R = 6371 km)
```

#### 3. 山位映射
```
根据计算的方位角，通过范围匹配找到对应的24山
例: 145.5° → 坤山（232.5° - 247.5°）
```

#### 4. 八卦推导
```
根据山位反查八卦表
坤 → 坤卦 | 乾 → 乾卦 | ...
```

---

## ⚙️ 限制条件

| 限制项 | 数值 | 说明 |
|-------|------|------|
| 原点数/案例 | ≤ 2 | V1规范要求 |
| 终点数/案例 | ≤ 5 | V1规范要求 |
| 连线数/案例 | 无限 | 2个原点×5个终点=10条最多 |
| 案例数 | 无限 | 取决于设备存储 |

---

## 🚀 功能对比

| 功能 | V1.0 | V2.0 | 说明 |
|------|------|------|------|
| 案例管理 | ✅ | ✅ | 创建/删除案例 |
| 点位添加 | ✅ | ✅ | 添加点位 |
| 点位分类 | ❌ | ✅ | 原点/终点区分 |
| 自动连线 | ❌ | ✅ | 原点-终点自动连接 |
| 方位角计算 | ❌ | ✅ | 两点间方位 |
| 距离计算 | ❌ | ✅ | 两点间直线距离 |
| 连线管理 | ❌ | ✅ | 查看/删除连线 |
| 八卦推导 | ✅ | ✅ | 从山位推导八卦 |
| 五行映射 | ✅ | ✅ | 山位五行属性 |

---

## 📝 常见问题

### Q: 删除原点时，关联的连线会怎样？
**A:** 自动删除与该原点相关的所有连线记录。

### Q: 可以有多条连线吗？
**A:** 可以。一个原点可与多个终点相连，自动生成对应数量的连线。

### Q: 点的坐标是真实的GPS位置吗？
**A:** 当前版本使用模拟数据演示功能。生产环境应集成真实GPS模块获取精确坐标。

### Q: 可以修改已添加的点吗？
**A:** 当前版本不支持修改，需要删除后重新添加。后续版本可加入编辑功能。

### Q: 案例数据会保存吗？
**A:** 当前版本数据存储在内存中。应用重启会丢失，建议后续集成AsyncStorage或数据库。

---

## 📈 后续开发建议

### 短期优化（v2.1）
- [ ] 添加点位编辑功能
- [ ] 支持点位名称批量修改
- [ ] 增强连线删除前的确认
- [ ] 添加操作撤销功能

### 中期功能（v2.2）
- [ ] 集成AsyncStorage本地存储
- [ ] 导出功能（PDF/图片/CSV）
- [ ] 点位搜索和过滤
- [ ] 连线距离排序

### 长期规划（v3.0）
- [ ] 实现真实地图展示
- [ ] 原点-终点连线可视化
- [ ] 云端数据同步
- [ ] 多用户协作功能
- [ ] 风水格局分析报告生成

---

## 📞 技术支持

- **问题报告**：检查控制台日志，查看错误信息
- **数据恢复**：暂无自动备份，建议定期导出重要案例
- **性能优化**：案例数量过多（>100）时性能可能下降

---

**版本**: V2.0  
**更新日期**: 2026年2月  
**作者**: AI Assistant
