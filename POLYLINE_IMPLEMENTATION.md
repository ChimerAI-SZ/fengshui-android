# 原点终点自动连线显示功能实现

## 概述
已成功增强MapScreen.kt以支持多案例管理和自动连线显示功能。现在应用支持：
- 多个堪舆案例的选择和切换
- 多个原点和多个终点的管理
- 自动原点-终点连线生成和显示
- 原点选择对话框（可选择要在地图上锁定显示的原点）

## 主要改动

### 1. 多案例管理（Lines 60-130）
**新增变量：**
- `projects`: 从数据库加载的所有堪舆案例列表
- `currentProject`: 当前选中的案例
- `originPoints`: 当前案例的所有原点列表
- `destPoints`: 当前案例的所有终点列表
- `selectedOriginPoint`: 当前选中的原点（用于在地图上显示）
- `linesList`: 连线数据结构，保存原点-终点对

**新增数据类：**
```kotlin
data class LineData(val origin: FengShuiPoint, val destination: FengShuiPoint)
```

**新增初始化逻辑：**
- 应用启动时自动加载所有项目
- 加载第一个项目的原点和终点数据

### 2. 数据加载函数（Lines 131-151）
```kotlin
fun loadProjectData(project: Project)
```
该函数：
- 从PointRepository加载指定案例的所有点位
- 按类型分离原点和终点
- 自动为每个原点与每个终点生成连线配对
- 将第一个原点设为默认选中

### 3. Google Maps连线初始化（Lines 224-238）
在GoogleMapView的onMapReady回调中：
- 在地图加载完成后立即添加所有现有的连线
- 使用蓝色线条显示连线（颜色：0xFF0000FF）
- 设置线条宽度为5f

### 4. 右侧控制按钮改进（Lines 346-410）

#### 新增案例选择按钮
```kotlin
Button(onClick = { showProjectSelectDialog = true })
```
显示所有可用的堪舆案例，允许用户切换案例。

#### 新增原点选择按钮  
```kotlin
Button(onClick = { 
    if (originPoints.isEmpty()) {
        // 显示提示
    } else {
        showOriginSelectDialog = true
    }
})
```
显示当前案例的所有原点，允许用户选择要在地图上显示的原点位置。

#### 改进的"加原点"按钮（Lines 412-458）
新逻辑：
- 检查是否选了案例，没有则提示用户
- 获取地图中心坐标
- 创建新原点并保存到数据库（关联到当前案例）
- **自动为该原点与所有现有终点生成连线**
- 调用mapProvider.addPolyline() 在地图上显示连线
- 锁定罗盘到新原点位置
- 移动地图视角到该原点

#### 改进的"加终点"按钮（Lines 460-507）
新逻辑：
- 检查是否选了案例，没有则提示用户
- 获取地图中心坐标
- 创建新终点并保存到数据库（关联到当前案例）
- **自动为所有现有原点与该终点生成连线**
- 调用mapProvider.addPolyline() 在地图上显示连线
- 更新UI显示新的连线信息

### 5. 案例选择对话框（Lines 627-652）
```kotlin
if (showProjectSelectDialog && projects.isNotEmpty()) {
    AlertDialog(
        // 显示所有案例列表
        // 点击案例时自动加载该案例的数据
    )
}
```

### 6. 原点选择对话框（Lines 654-690）
```kotlin
if (showOriginSelectDialog && originPoints.isNotEmpty()) {
    AlertDialog(
        // 显示当前案例的所有原点
        // 点击原点时：
        //   1. 设为当前选中的原点
        //   2. 锁定罗盘到该原点
        //   3. 动画移动地图到原点位置
    )
}
```

### 7. 工具函数（Line 695）
```kotlin
private fun Double.format(digits: Int) = "%.${digits}f".format(this)
```
用于在原点选择对话框中显示经纬度坐标。

## 工作流程

### 初次使用
1. 应用启动，自动加载所有案例
2. 如果有案例，选中第一个案例并加载其原点和终点
3. 所有已存在的原点-终点连线自动在地图上显示

### 添加新原点
1. 用户点击"➕原点"按钮
2. 在地图中心创建原点
3. **自动与所有现有终点生成连线**
4. 所有连线立即显示在地图上
5. 地图视角自动移到新原点位置

### 添加新终点
1. 用户点击"➕终点"按钮
2. 在地图中心创建终点
3. **自动与所有现有原点生成连线**
4. 所有连线立即显示在地图上

### 切换案例
1. 用户点击"📋 案例"按钮
2. 选择一个不同的案例
3. UI自动加载该案例的原点和终点
4. 所有该案例的连线自动刷新显示

### 选择原点
1. 用户点击"📍 原点"按钮
2. 在列表中选择一个原点
3. 罗盘锁定到该原点
4. 地图视角移动到该原点位置

## 技术细节

### 数据持久化
- 原点和终点数据保存在SharedPreferences中
- 原点通过`groupId`（即projectId）与案例关联
- 支持跨应用会话的数据恢复

### 连线显示机制
1. **数据层**：originPoints和destPoints列表中的点对应LineData对象
2. **显示层**：通过mapProvider.addPolyline()在GoogleMap上绘制连线
3. **颜色编码**：蓝色线条（0xFF0000FF）表示原点-终点连接

### 自动连线逻辑
- 当添加原点时：与所有现有终点配对
- 当添加终点时：与所有现有原点配对
- **一对多关系支持**：每个原点可有多个终点，反之亦然

## 与PointRepository的集成
使用现有的PointRepository方法：
- `loadProjects()` - 加载所有案例
- `getPointsByCase(caseId)` - 按案例ID获取点位
- `createPoint()` - 创建新点位
- 支持groupId来关联点位到案例

## 限制和注意事项

1. **Trial Limits**：
   - 创建点位时仍会检查试用限制
   - 捕获并显示TrialLimitException错误

2. **地图准备**：
   - 连线绘制依赖GoogleMapView.onMapReady回调
   - 若地图未就绪，addPolyline可能失败（需要GoogleMap对象）

3. **性能**：
   - 大量原点-终点对（如500+）可能会影响地图性能
   - 当前实现为每对都单独添加一条线

4. **当前设计**：
   - 仍保留了旧的单原点/单终点变量（originPoint, destPoint）以兼容性
   - 可在后续版本中完全移除这些遗留代码

## 下一步改进建议

1. **样式优化**：
   - 支持不同颜色的线条来区分不同的原点
   - 添加线条点击事件以显示连线详情

2. **性能优化**：
   - 在Compose中绘制线条而不依赖GoogleMapProvider（减少SDK调用）
   - 使用线条缓存防止重复添加

3. **UI增强**：
   - 在地图上显示点位标记（当前只有连线）
   - 添加连线编辑功能（修改、删除）
   - 显示连线的方位角、距离等信息

4. **案例管理**：
   - 在MapScreen中添加"新建案例"功能
   - 支持案例的删除和编辑

## 测试清单
- [ ] 启动应用，验证第一个案例自动加载
- [ ] 验证现有连线在地图上显示
- [ ] 添加新原点，验证自动连线显示
- [ ] 添加新终点，验证自动连线显示
- [ ] 点击案例选择，验证切换案例功能
- [ ] 点击原点选择，验证罗盘锁定和视角移动
- [ ] 验证连线基本信息显示（方位角、距离等）

## 文件修改摘要
- **MapScreen.kt**: 主要改动，添加多案例、原点/终点管理、自动连线功能
  - 新增：约150行代码用于案例管理和UI对话框
  - 改动：加原点/加终点按钮的逻辑
  - 兼容：保持现有API和搭建
